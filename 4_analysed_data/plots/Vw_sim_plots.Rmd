---
title: "Vw_sim_plots"
author: "Manas GA"
date: "2024-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(ggplot2)
library(cowplot)
library(latex2exp)
```

## Function to make "standard" plot

```{r}
make_std_plots = function(data, font_size = 15, end_gen = 25000){
  
  # vA_est ~ vA_true

p_main = ggplot(data, aes(y = vA_est, x = vA_true)) + 
  theme_bw() + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)")) + 
  theme(text = element_text(size = font_size)) 
  
# palpha_est histogram

p_palpha = ggplot(data, aes(x = palpha_est)) + 
  theme_bw() + 
  geom_histogram(color = "black", fill = "white") + 
  labs(x = TeX(r"(Estimate of $p_{\alpha} $)"), y = "Frequency") + 
  geom_vline(xintercept = 0, color = "red") +  
  geom_vline(xintercept = mean(data$palpha_est), linetype = "dashed") +
  theme(text = element_text(size = font_size)) 

# balpha_intercept_est histogram

p_balpha_int = ggplot(data, aes(x = balpha_intercept_est)) + 
  theme_bw() + 
  geom_histogram(color = "black", fill = "white") + 
  labs(x = TeX(r"(Estimate of $\beta^{(0)}_{\bar{\alpha}}$)"), y = "Frequency") + 
  geom_vline(xintercept = 0, color = "red") + 
  geom_vline(xintercept = mean(data$balpha_intercept_est), linetype = "dashed") +
  theme(text = element_text(size = font_size)) 

# balpha_slope_est histogram

p_balpha_slope = ggplot(data, aes(x = balpha_slope_est)) + 
  theme_bw() + 
  geom_histogram(color = "black", fill = "white") + 
  labs(x = TeX(r"(Estimate of $\beta^{(1)}_{\bar{\alpha}}$)"), y = "Frequency") + 
  geom_vline(xintercept = 0, color = "red") + 
  geom_vline(xintercept = mean(data$balpha_slope_est), linetype = "dashed") +
  theme(text = element_text(size = font_size))

# Combine the four plots

p_combined = plot_grid(p_main, p_palpha, p_balpha_int, p_balpha_slope, labels = "AUTO")

# Title

ml = unique(data$sequence_length*data$r)
if(length(ml)>1){stop("The data set does not have the same map length in the burnin phase in every simulation.")}

ml_expt = unique(data$sequence_length*data$r_expt)
if(length(ml_expt)>1){stop("The data set does not have the same map length in the experiment in every simulation.")}

end_gen = unique(data$end_gen)
if(length(end_gen)>1){stop("The data doe not have have the same end_gen for every simulations")}

if(end_gen==2){
  ml = unique(data$sequence_length*data$r_msp)
  if(length(ml)>1){stop("The data set does not have the same map length in the burnin phase in every simulation.")}
}else{
  ml = unique(data$sequence_length*data$r)
  if(length(ml)>1){stop("The data set does not have the same map length in the burnin phase in every simulation.")}
}

mu_alpha = (data$shape)*(data$shape)

title = ggdraw() + draw_label(paste("Map length in burnin = ", ml, " M, Map length in experiment = ", ml_expt, " M, scale = ", data$scale, sep = ""), hjust = 0.5, size = font_size)

# Add title
p_combined = plot_grid(title, p_combined, ncol = 1, rel_heights = c(0.1,1))
  

return(list(main = p_main, palpha = p_palpha, balpha_int = p_balpha_int, balpha_slope = p_balpha_slope,
            combined = p_combined))

  
}
```

## Simulations without burnin

Selection coefficients were drawn from a gamma distribution (shape = 0.3, scale = 0.033) and assigned to mutations randomly. The recombination rate in the msprime simulation was 5.32e-07. Map length in the burnin phase of just 1 generation (eng_gen = 2) was 25.

### Small map length in the experiment 

Standard parameters:

Map length in the experiment phase (ml_exp) = 0.1 M
Number of individuals in the experiment (n_ind_exp) = 1000
Number of cages (n_cages) = 10
ngen2 = 4



```{r}

d_0 = read.csv("../combined_data/Set_0_output.csv") # Data for the standard set
d_2 = read.csv("../combined_data/Set_2_output.csv") # Varying r_expt, n_ind_exp, n_cages, ngen2

d_nb_0.1  = rbind(d_0, d_2)

##################################################################################################
####### Standard plots (Set_0: ml_expt = 0.1, n_indxpt = 1000, n_cages = 10, ngen2 = 4) ##########
##################################################################################################

p_nb_0.1_std = make_std_plots(d_0)

ggsave(p_nb_0.1_std$combined, width = 8, height = 8, file = "p_nb_0.1_std.jpg")
p_nb_0.1_std$combined

```

We then vary ml_expt, n_ind_exp, n_cages, and ngen2 one at a time while keeping the other parameters fixed at their standard values.

```{r}
### ml_expt ###

d_nb_0.1_ml = d_nb_0.1[d_nb_0.1$n_ind_exp==1000&d_nb_0.1$n_cages==10&d_nb_0.1$ngen2==4,]
p_nb_0.1_ml = ggplot(d_nb_0.1_ml , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r_expt))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length (M)") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE)

### n_ind_exp ###
d_nb_0.1_nind = d_nb_0.1[d_nb_0.1$r_exp==1e-7&d_nb_0.1$n_cages==10&d_nb_0.1$ngen2==4,]
p_nb_0.1_nind = ggplot(d_nb_0.1_nind , aes(y=vA_est, x = vA_true, color = factor(n_ind_exp))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Population size") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

### n_cages ###

d_nb_0.1_ncages = d_nb_0.1[d_nb_0.1$r_exp==1e-7&d_nb_0.1$n_ind_exp==1000&d_nb_0.1$ngen2==4,]
p_nb_0.1_ncages = ggplot(d_nb_0.1_ncages , aes(y=vA_est, x = vA_true, color = factor(n_cages))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Replicate \npopulations") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

### ngen_expt ###

d_nb_0.1_ngen2 = d_nb_0.1[d_nb_0.1$r_exp==1e-7&d_nb_0.1$n_ind_exp==1000&d_nb_0.1$n_cages==10,]
p_nb_0.1_ngen2 = ggplot(d_nb_0.1_ngen2 , aes(y=vA_est, x = vA_true, color = factor(ngen2-ngen1))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Generations") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

p_nb_0.1_combined = plot_grid(p_nb_0.1_ml, p_nb_0.1_nind, p_nb_0.1_ncages, p_nb_0.1_ngen2, labels = "AUTO")

p_nb_0.1_combined
ggsave(p_nb_0.1_combined, width = 12, height = 8, file = "p_nb_0.1_combined.jpg")

```

### Set_5: Larger map length in the experiment (standard value = 2 M)

Not varying the map length in burnin (fixed to 5 M)

```{r}
d_5 = read.csv("../combined_data/Set_5_output.csv")
d_5_std = d_5[d_5$r_expt*d_5$sequence_length==2&d_5$n_ind_exp==1000&d_5$n_cages==10&d_5$ngen2==4,] # Data for the standard set

##################################################################################################
####### Standard plots (Set_0: ml_expt = 2, n_indxpt = 1000, n_cages = 10, ngen2 = 4) ############
##################################################################################################

p_nb_2_std = make_std_plots(d_5_std)

ggsave(p_nb_2_std$combined, width = 8, height = 8, file = "Manuscript_figures/Fig1.jpg")
p_nb_2_std$combined

#ggsave(p_nb_2_std$main, width = 5, height = 5, file = "talk_noburnin.jpg")
p_nb_2_std$combined


```

We then vary ml_expt, n_ind_exp, n_cages, and ngen2 one at a time while keeping the other parameters fixed at their standard values.
```{r}
### ml_expt ###

d_5_ml = d_5[d_5$n_ind_exp==1000&d_5$n_cages==10&d_5$ngen2==4,]
p_nb_2_ml = ggplot(d_5_ml , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r_expt))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length in\nexperiment (M)") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE)

### n_ind_exp ###
d_5_nind = d_5[d_5$r_exp==2e-6&d_5$n_cages==10&d_5$ngen2==4,]
p_nb_2_nind = ggplot(d_5_nind , aes(y=vA_est, x = vA_true, color = factor(n_ind_exp))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Population size") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

### n_cages ###

d_5_ncages = d_5[d_5$r_exp==2e-6&d_5$n_ind_exp==1000&d_5$ngen2==4,]
p_nb_2_ncages = ggplot(d_5_ncages , aes(y=vA_est, x = vA_true, color = factor(n_cages))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Replicate \npopulations") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

### ngen_expt ###

d_5_ngen2 = d_5[d_5$r_exp==2e-6&d_5$n_ind_exp==1000&d_5$n_cages==10,]
p_nb_2_ngen2 = ggplot(d_5_ngen2 , aes(y=vA_est, x = vA_true, color = factor(ngen2-ngen1))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Generations") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) 

p_nb_2_combined = plot_grid(p_nb_2_ml, p_nb_2_nind, p_nb_2_ncages, p_nb_2_ngen2, labels = "AUTO")

title = ggdraw() + draw_label("Abbreviated simulations", hjust = 0.5, size = 20)

# Add title
p_nb_2_combined = plot_grid(title, p_nb_2_combined, ncol = 1, rel_heights = c(0.1,1))

p_nb_2_combined
ggsave(p_nb_2_combined, width = 12, height = 8, file = "Manuscript_figures/Fig2.jpg")
```



## Simulations with burnin

### Set 1 (ml = 25, ml_exp = 0.1)

```{r}
d_1 = read.csv("../combined_data/Set_1_output.csv")
p_b_25_0.1_std = make_std_plots(d_1)
ggsave(p_b_25_0.1_std$combined, width = 8, height = 8, file = "p_b_25_0.1_std.jpg")
p_b_25_0.1_std$combined
```
### Set 3 (ml = 25, ml_exp = 15)

```{r}
d_3 = read.csv("../combined_data/Set_3_output.csv")
p_b_25_15_std = make_std_plots(d_3)
ggsave(p_b_25_15_std$combined, width = 8, height = 8, file = "p_b_25_15_std.jpg")
p_b_25_15_std$combined
```
### Set 4 (ml = 5, ml_exp = 15)
```{r}
d_4 = read.csv("../combined_data/Set_4_output.csv")
p_b_5_15_std = make_std_plots(d_4)
ggsave(p_b_5_15_std$combined, width = 8, height = 8, file = "p_b_5_15_std.jpg")
p_b_5_15_std$combined
```

### Set 6 (varying ml_exp: 0.01, 0.2, 2 (reference)) and 7 (varying ml: 0.5, 5 (reference), 50)

```{r}
d_6 = read.csv("../combined_data/Set_6_output.csv")
d_6_std = d_6[d_6$r*d_6$sequence_length==5&d_6$r_exp*d_6$sequence_length==2,]
p_b_5_2_std = make_std_plots(d_6_std)
ggsave(p_b_5_2_std$combined, width = 8, height = 8, file = "p_b_5_2_std.jpg")
p_b_5_2_std$combined

### ml_expt ###

p_b_5_2_ml_exp = ggplot(d_6 , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r_expt))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length (M)", title = paste("Map length in burnin = ", unique(d_6$sequence_length*d_6$r), " M", sep = "")) + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5))

ggsave(p_b_5_2_ml_exp, width = 8, height = 8, file = "p_b_5_2_ml_exp.jpg")
p_b_5_2_ml_exp

d_7 = read.csv("../combined_data/Set_7_output.csv")

d_7_std = d_7[d_7$r==5e-7,]

p_b_0.5_2_std = make_std_plots(d_7_std)
ggsave(p_b_0.5_2_std$combined, width = 8, height = 8, file = "p_b_0.5_2_std.jpg")
p_b_0.5_2_std$combined

d_7_ml = rbind(d_7, d_6_std)

### ml ###

p_b_5_2_ml = ggplot(d_7_ml , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length \nin burnin (M)") + 
  scale_color_manual(values = c("#D01C8B", "#0072B2", "#999999")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  labs(title = TeX(r"(Non-neutral $\mu_{\alpha}$ = 0.03)"))

p_b_5_2_ml


```
### Set 8 (larger simulations (scale = 0.033): ml = 0.5, ml_exp = 2) (pilot)
```{r}
d_8 = read.csv("../combined_data/Set_8_output.csv") # Data for the standard set

p_b_large_std = make_std_plots(d_8)
ggsave(plot = p_b_large_std$combined, width = 8, height = 8, file = "p_b_large_0.5_2_ml_pilot.jpg")
p_b_large_std$combined




```

### Set 9 (larger simulations (scale = 0.033): ml = 0.5, ml_exp = 2)
```{r}
d_9 = read.csv("../combined_data/Set_9_output.csv") # Data for the standard set

d_9_std = d_9[d_9$all.gp==FALSE,]

p_b_large_std = make_std_plots(d_9_std)
#ggsave(plot = p_b_large_std$combined, width = 8, height = 8, file = "p_b_large_0.5_2_ml.jpg")
ggsave(plot = p_b_large_std$combined, width = 8, height = 8, file = "Manuscript_figures/Fig3.jpg")
p_b_large_std$combined

ggsave(plot = p_b_large_std$main, width = 5, height = 5, file = "talk_burnin_del.jpg")

# Plots for all.gp==TRUE

p_b_large_all.gp = make_std_plots(d_9[d_9$all.gp==TRUE,])
ggsave(plot = p_b_large_all.gp$combined, width = 8, height = 8, file = "p_b_large_0.5_2_ml_all.gp.jpg")
p_b_large_all.gp$combined






```



### Set_N1 (scale = 0.045): ml = c (5, 50, 250), ml_exp = 2, mut_ratio = 0 

```{r}
d_N1 = read.csv("../combined_data/Set_N1_output.csv")

### ml ###

p_b_0.045_ml = ggplot(d_N1 , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length \nin burnin (M)", title = TeX(r"(Non-neutral $\mu_{\alpha}$ = 0.0135)")) + 
  scale_color_manual(values = c("#D01C8B", "#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5))

p_b_0.045_ml

extra_ml_combined = plot_grid(p_b_5_2_ml, p_b_0.045_ml, nrow = 2, labels = "AUTO")

ggsave(extra_ml_combined, width = 6, height = 9, file = "manuscript_figures/FigS1.jpg")

```

### Set 11 (larger simulations (scale = 0.033): ml = 0.5, ml_exp = 2, mut_ratio = 0.0002) 

```{r}
d_11 = read.csv("../combined_data/Set_11_output.csv") # Data for the standard set

p_b_large_ben_std = make_std_plots(d_11)
ggsave(plot = p_b_large_ben_std$combined, width = 8, height = 8, file = "p_b_large_0.5_2_ben.jpg")
p_b_large_std$combined

# Combined plot for proportion of beneficial mutations

p_ben_0.033 = ggplot(rbind(d_9_std, d_11), aes(y = vA_est, x = vA_true, color = factor(format(mut_ratio, scientific = FALSE)))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Proportion of \nbeneficial \nmutations") + 
  scale_color_manual(values = c("#0072B2", "#999999")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5))

p_ben_0.033
```

### Set_12 Varyingthe map length in the experiment phase (scale = 0.033): ml_exp = c(0.01, 0.2, 2), mut_ratio = 0

Needs data from set_12 as well as set_9

```{r}
d_9 = read.csv("../combined_data/Set_9_output.csv") # Data for the standard set
d_12 = read.csv("../combined_data/Set_12_output.csv") # Data when mu_exp was varied
d_ml_exp = rbind(d_9, d_12)

p_ml_exp_0.033 = ggplot(d_ml_exp , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r_expt))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length in \nexperiment (M)") + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5)) 

ggsave(p_ml_exp_0.033, width = 8, height = 8, file = "p_ml_exp_0.033.jpg")
p_ml_exp_0.033
```

## Simulations with burnin (varying the scale)

Needs datasets for set 7, set 9, and set N1

```{r}
d_scale_0.033 = rbind(d_7[d_7$r==5e-07,], d_9_std, d_N1[d_N1$r==5e-07,])

p_scale_0.033 = ggplot(d_scale_0.033 , aes(y=vA_est, x = vA_true, color = factor(scale*shape))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = TeX(r"(Non-neutral $\mu_{\alpha}$)")) + 
  scale_color_manual(values = c("#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5)) 
p_scale_0.033
```

## Simulations with burnin (varying the map length) (scale = 0.033)

```{r}

d_13 = read.csv("../combined_data/Set_13_output.csv")

# Combine with the standard data set

d_13 = rbind(d_9_std, d_13)

p_b_0.033_ml = ggplot(d_13 , aes(y=vA_est, x = vA_true, color = factor(sequence_length*r))) +
  theme_bw() + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  labs(x = TeX(r"(True $V_A$)"), y = TeX(r"(Estimate of $V_A$)"), color = "Map length \nin burnin (M)") + 
  scale_color_manual(values = c("#D01C8B", "#0072B2", "#999999", "#009E73")) + 
  theme(text = element_text(size = 15)) +
  geom_smooth(method = "lm", se=FALSE) +
  theme(plot.title = element_text(hjust = 0.5))

p_b_0.033_ml


```


## Combine plots for large (scale = 0.033) simulations with burnin

```{r}
p_b_0.033_combined = plot_grid(p_ml_exp_0.033, p_b_0.033_ml, p_ben_0.033, p_scale_0.033,  ncol = 2, labels = "AUTO")

title = ggdraw() + draw_label("Full simulations", hjust = 0.5, size = 20)

# Add title
p_b_0.033_combined = plot_grid(title, p_b_0.033_combined, ncol = 1, rel_heights = c(0.1,1))
p_b_0.033_combined

ggsave(p_b_0.033_combined, width = 12, height = 8, file = "manuscript_figures/Fig4.jpg")

# Separate subplots for Jarrod's talk

ggsave(p_nb_2_std$main, width = 5, height = 5, file = "Fig.1A.jpg")
ggsave(p_nb_2_ml, width = 5, height = 5, file = "Fig.2A.jpg")
ggsave(p_nb_2_nind, width = 5, height = 5, file = "Fig.2B.jpg")
ggsave(plot = p_b_large_std$main, width = 5, height = 5, file = "Fig.3A.jpg")
ggsave(p_b_0.045_ml + labs(title = TeX(r"(Non-neutral $\mu_{\alpha}$ = 0.0135)")), width = 5, height = 5, file = "Fig.4B.jpg")
ggsave(p_ben_0.033, width = 5, height = 5, file = "Fig.4C.jpg")
ggsave(p_scale_0.033, width = 5, height = 5, file = "Fig.4D.jpg")


```

## Additive genic variance lost during the experiment

Plot the fraction of the initial additive genic variance lost by the end of the experiment as a function of non-neutral \mu_{\alpha}. Then, identify the simulations with the greatest and smallest losses and plot locuswise fraction V_a lost vs abs(\alpha) for these simulations. The target simulations are "Set_7_c5_2024-12-18_22-42-43.451498_2.08686868686869e-08_0.5_2_1000_10_4_0_0" (greatest loss in V_a) and  sim 1. (sims are set to 1 by default when run on the AC3 cluster)
```{r va_lost}

d_va_lost = read.csv("../combined_data/va_lost_combined.csv")

plot_lost_va = ggplot(d_va_lost, aes(y = ((va_true - va_left)/va_true), x = factor(round(shape*scale, digits = 4)))) +
  theme_bw() +
  geom_boxplot() +
  labs(y = TeX(r"(Fraction of the total $V_a(0)$ lost)"), x = TeX(r"(Non-neutral $\mu_{\alpha}$)")) +
  theme(text = element_text(size = 15)) 

# Identify the simulation with the greatest fraction loss in V_a
message("Simulation with the geratest relative loss in initial additive genic variance:")
d_va_lost[which(d_va_lost$va_left/d_va_lost$va_true == min (d_va_lost$va_left/d_va_lost$va_true)),]$Set_ID

# Identify the simulation with the smallest fraction loss in V_a
message("Simulation with the smallest relative loss in initial additive genic variance:")
d_va_lost[which(d_va_lost$va_left/d_va_lost$va_true == max (d_va_lost$va_left/d_va_lost$va_true)),]$Set_ID

# The analysis was run on AC3

# Load data

# Maximum loss
d_finescale_max = read.csv("../Set_7_c5_2024-12-18_22-42-43.451498_2.08686868686869e-08_0.5_2_1000_10_4_0_0_sim_1_finescale_va_ac3-n6_2025-03-14_11-47-27.887772.csv")
# Minimum loss
d_finescale_min = read.csv("../Set_9_biggar_2024-12-26_00-57-26.676051_9.60363636363636e-08_0.5_2_1000_10_4_0_0_sim_1_finescale_va_ac3-n6_2025-03-14_13-08-48.187668.csv")
d_finescale = rbind(d_finescale_max, d_finescale_min)

d_finescale$locuswise_va_lost = d_finescale$locuswise_va_true - d_finescale$locuswise_va_left
d_finescale$lost_va_type = ifelse(d_finescale$Set_ID=="Set_9_biggar_2024-12-26_00-57-26.676051_9.60363636363636e-08_0.5_2_1000_10_4_0_0", "Min.", "Max.")

va_true_min = sum(d_finescale[d_finescale$Set_ID=="Set_9_biggar_2024-12-26_00-57-26.676051_9.60363636363636e-08_0.5_2_1000_10_4_0_0",]$locuswise_va_true)
va_true_max = sum(d_finescale[d_finescale$Set_ID=="Set_7_c5_2024-12-18_22-42-43.451498_2.08686868686869e-08_0.5_2_1000_10_4_0_0",]$locuswise_va_true)

# Restricting to selected loci only
d_finescale_sel = d_finescale[d_finescale$list_alpha!=0,]

# Calculate the fraction of the total initial V_a lost at each locus
d_finescale_sel$fract_locuswise_va_lost = ifelse(d_finescale_sel$lost_va_type=="Max.", d_finescale_sel$locuswise_va_lost/va_true_max, d_finescale_sel$locuswise_va_lost/va_true_min)

plot_finescale_relative_va_lost = ggplot(d_finescale_sel, aes(y = fract_locuswise_va_lost, x = abs(list_alpha), color = lost_va_type)) +
  theme_bw() +
  geom_point() +
  labs(y = TeX(r"($V_a$ lost at a locus / Total $V_a(0)$)"), x = TeX(r"(Non-neutral $\alpha$)"), color = "Simulation type") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("Min." = "#00BFC4", "Max." = "#F8766D"),
    labels = c("Min." = TeX(r"(Min. $V_a$ lost)"), "Max." = TeX(r"(Max. $V_a$ lost)"))  # Custom legend labels
  )

### Combine the two plots ###

va_lost_combined_plot = plot_grid(plot_lost_va, plot_finescale_relative_va_lost, ncol = 1, nrow = 2, labels = "AUTO")

ggsave(va_lost_combined_plot, width = 6, height = 9, file = "manuscript_figures/FigS2.jpg")
  

```

